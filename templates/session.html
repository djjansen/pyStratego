<!DOCTYPE html>
  <html lang="en">
  <head>
    <style>
      table, th, td {
        border: 1px solid black;
        border-collapse: collapse;
      }
      .click a {
        display: block;
      }
      .board table {
        width: 90%;
      }
      .blue {
        background-color: blue;
      }
      .red {
        background-color: red;
      }
      td {
        width: 9.09%;
        position: relative;
      }
      td:after {
        content: '';
        display: block;
        margin-top: 100%;
      }
      .square {
        display: table;
      }
      .content {
        font-size:7vw;
        color:white;
        text-align:center;
        vertical-align: bottom;
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
      }
  </style>
    <title>Flask_Chat_App</title>
  </head>
  <body>
    <h1>{{ session.get('user_id') }}</h1>
     <ul>
      <li><a href="{{ url_for('auth.logout') }}">Log Out</a>
    </ul>
      <h2>Game Code</h2>
      <h3>{{ session.get('session_code') }}</h3>
      <!-- table for pieces not on the board -->
      
      <table id="chest" border="1px solid black" border-collapse="collapse" width="90%">
            {% set i = [] %}
            {% for piece in session.get('unplaced_pieces') %}
            {% if session.get('unplaced_pieces').index(piece) == 0 %}
              <tr>
            {% endif %}
            {% for x in range(piece[1]) %}
            {% set __ = i.append(1) %}
              <td><div class="square"><div class="content {{ session.get('color') }}">{{ piece[0] }}</div></div></td>
            {% if i|length % 10 == 0 %}
              </tr><tr>
            {% endif %}
            {% endfor %}
            {% endfor %}
              </tr>
      </table>
      <!-- Table for game board -->
      <table id="grid" class="board" border="1px solid black" border-collapse="collapse" width="90%">
            <tr>
                <th></th>
              {% for n in range(10) %}
                <th>{{ n+1 }}</th>
              {% endfor %}
            </tr>
          {% for row in session.get('board_state') %}
            <tr id = {{ row }} >
                <td class="board"><div class="square"><div class="content">{{ row }}</div></div></td>
            {% for cell in session.get('board_state')[row] %}
                {% set cellContent =  session.get('board_state')[row][cell]['piece'] %}
                <td class="board" id= {{ cell }} ><div class="square"><div class="content {{ session.get('board_state')[row][cell]['color'] }}">
                {% if session.get('board_state')[row][cell]['color'] == session.get('color') %}
                  {{ cellContent }}
                {% endif %}
                </div></div></td>
            {% endfor %}
            </tr>
          {% endfor %}
      </table>
      <script>
      function extractData(target) {
      target.classList.add("selected");
      window.transfer_payload = target.innerHTML;
      console.log(transfer_payload);
      }

      function loadData(target) {
      target.innerHTML = window.transfer_payload;
      var origin = document.getElementsByClassName("selected")[0]
      var origin_coords = [origin.parentNode.parentNode.parentNode.id,origin.parentNode.parentNode.id];
      var target_coords = [target.parentNode.parentNode.parentNode.id,target.parentNode.parentNode.id];
      var team = "{{ session.get('color') }}";
      target.classList.add(team);
      console.log
      origin.classList.remove("selected","blue","red");
      origin.innerHTML = "";
      socket.emit( 'board state', {
            origin_cell : origin_coords,
            destination_cell : target_coords,
            moved_piece : {'team':team,'piece':window.transfer_payload}
          });
      console.log('transfer');
      delete window.transfer_payload;
      }

      function handleData(evt) {
      var clickedOn = evt.target;
      if (typeof window.transfer_payload !== 'undefined') {
        loadData(clickedOn);
      } else {
        extractData(clickedOn);
      }}

      function changeColor(evt){
      var clickedOn= evt.target;
      // for HTML
      clickedOn.style.backgroundColor = '#f00';
      }


      var grid = document.getElementById("grid");
      for (var i = 1, row; row = grid.rows[i]; i++) {
         //iterate through rows
         //rows would be accessed using the "row" variable assigned in the for loop
         console.log(i)
         for (var j = 1, col; col = row.cells[j]; j++) {
           //iterate through columns
           //columns would be accessed using the "col" variable assigned in the for loop
           col.querySelector('.square').addEventListener('click',handleData,false);
         }  
      }
      var chest = document.getElementById("chest");
      for (var i = 0, row; row = chest.rows[i]; i++) {
         //iterate through rows
         //rows would be accessed using the "row" variable assigned in the for loop
         console.log(i)
         for (var j = 0, col; col = row.cells[j]; j++) {
           //iterate through columns
           //columns would be accessed using the "col" variable assigned in the for loop
           col.querySelector('.square').addEventListener('click',handleData,false);
         }  
      }
      </script>

    <div class="message_holder">
      {% block content %}
          <!-- {% if g.messages %} -->
            {% for message in g.messages %}
            <div><b style="color: #000">{{ message['user_name'] }}  </b>
            {{ message['message'] }}</div>
            {% endfor %}
          <!-- {% endif %} -->
      {% endblock %}
    </div>

    <form action="" method="POST">
      <input type="text" class="message" placeholder="Messages"/>
      <input type="submit"/>
    </form>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>
    <script type="text/javascript">
      var socket = io.connect('http://' + document.domain + ':' + location.port);
      var session_id = 

      socket.on( 'connect', function() {
        socket.emit( 'my event', {
          data: 'User Connected'
        } );

        console.log('Creating game...');
        socket.emit('create', {
          data: '{{ g.session_id }}'
        });

        // message handler for the 'join_room' channel
        socket.on('join_room', function(msg) {
            console.log(msg);
        });

        var form = $( 'form' ).on( 'submit', function( e ) {
          e.preventDefault()
          let user_name = '{{ session.get("user_id") }}'
          let user_input = $( 'input.message' ).val()
          socket.emit( 'chat message', {
            user_name : user_name,
            message : user_input
          } )
          $( 'input.message' ).val( '' ).focus()
        } )
      } )


      socket.on( 'my response', function( msg ) {
        console.log( msg )
        console.log("breakpoint")
        if( typeof msg.user_name !== 'undefined' ) {
          $( 'div.message_holder' ).append( '<div><b style="color: #000">'+msg.user_name+'</b> '+msg.message+'</div>' )
        } else {
          console.log( 'yayyyyy')
        }
      })
      
    </script>

  </body>
  </html>